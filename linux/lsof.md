# lsofコマンド入門

## はじめに
サーバーで特定のポート番号を待ち受けているかどうか、指定ファイルは誰が読み込んでいるのかを調べたいときがあります。その際に役立つlsofコマンドについて調べてみました。

## lsofコマンドとは
プロセスが開いているファイルを表示するコマンドです。

## オプション

オプション|意味
---|---
-P|ポート番号をサービス名に変換しない
-c|プロセス名を指定する
-i|ネットワークソケットファイルを指定する
-n|IPアドレスを表示する（名前解決しない）
-p|プロセスIDを指定する

## 出力されている情報

項目|意味
---|---
COMMAND|実行されているコマンド
PID|プロセスID
USER|実行ユーザー
FD|ファイルディスクリプタ
TYPE|タイプ
DEVICE|デバイス
SIZE/OFF|ファイルサイズ
NODE|プロトコル
NAME|ファイル又はポート

### NAME
* (LISTEN): 待ち受け状態

## 利用方法

### 全プロセスを表示する

オプションを付与しないと全てのプロセスについて表示する

```console
$ lsof
```

### 特定のポート番号で実行中のプロセスを調べる

```console
$ lsof -i:80 -P 
```

### 対象のファイルを指定する

```console
$ lsof /var/log/httpd/access_log
```

### コマンドを指定する

```console
$ lsof -c httpd
```

### ユーザーを指定する

```console
$ lsof -u nginx
```

### ネットワークコネクションを出力する

```sh
$ lsof -i
```

#### ポート番号を指定する

```sh
$ lsof -i:80 -P
```

複数ポート番号を指定できる
```sh
$ lsof -i:80,8080 -P
```

## まとめ

lsofコマンドは多機能なので全てを使いこなすのは難しそうですが、普段の運用で利用するのはほんの一握りの機能でも十分です。まずは基礎を覚えるだけでも、調査と原因究明が捗るようになるので、是非今後も利用していきたいです。

## 参考
* [ネットワーク管理の基本Tips：このポートで実行中のプロセスはどれ？ lsofコマンドの使い方 \- ＠IT](http://www.atmarkit.co.jp/ait/articles/1510/05/news014.html)
* [lsofの使い方 \- プロセスが使用中のファイルを調べる \- うまいぼうぶろぐ](http://hogem.hatenablog.com/entry/20070223/1172221315)
* [lsofコマンドで覚えておきたい使い方9個 \| 俺的備忘録 〜なんかいろいろ〜](https://orebibou.com/2016/04/lsof%E3%82%B3%E3%83%9E%E3%83%B3%E3%83%89%E3%81%A7%E8%A6%9A%E3%81%88%E3%81%A6%E3%81%8A%E3%81%8D%E3%81%9F%E3%81%84%E4%BD%BF%E3%81%84%E6%96%B99%E5%80%8B/)
