# ぎんざRuby会議01
## 応募枠
LT枠(5分）

## タイトル
歴史あるPHPアプリケーションのジョブキューシステムのリプレース

## 概要
レガシー化したPHPアプリケーションで、独自のジョブキューシステムを開発・運用していました。システムこそ正常に動いていましたが、内部システムと密結合、ミドルウェアの老朽化、動作検証が困難という課題を抱えていました。

それら課題解決のため、ジョブキューシステムの再構築を決定。各種フレームワーク・ミドルウェアを検討した結果、Rails 5 API + ActiveJob + SQSで、ジョブキューを再構築しました。PHPerが、なぜRailsを選択したのか。選択した理由、良かったこと、悪かったことは何かをお話します。

## 本セッションのポイント
* PHPがなぜRailsを選択肢たのか
* 良かったこと、悪かったこと

## プレゼンテーション

* タイトル：歴史あるPHPアプリケーションのジョブキューシステムのリプレース
* 自己紹介
		* PHPer, Vue.js, Rails
* 今日のお話は自社サービスではなく、週末開発のサービスでのお話
* お題：Ruby on Rails
* 歴史あるPHPアプリケーション
		* サービス開始から7年目のとあるレビューサイト
		* PHP5.1 + CakePHP1.3
					* Rubyで言う所のRuby n + Rails hoge
		* 月間約600万PV ユーザー数36万
		* 週末開発
* システム構成
		* AWS
		* Webサーバー x 2 + オートスケール
		* Mail
		* DB
		* Image
		* Batch x 1(+ 独自ジョブキューシステム)
* 独自ジョブキューシステム
		* CakePHP上でキューイング、ジョブの実行を独自に実装
		* ジョブはDB管理
		* cronで毎分実行、ジョブのスケジュール確認 
* 独自ジョブキューシステムの課題
		* 動作検証が困難
		* ユニットテストがなく、開発しづらい
		* 密結合
* ゴール
		* 開発しやすくしたい
		* 疎結合にしたい
		* ユニットテストを導入したい
		* (本質的ではないが)レガシー環境から脱却したい
* 構想
		* BEFORE
				* Batch( + 独自ジョブキューシステム)
		* AFTER
				* APP + Batch + ジョブキューAPIサーバー + SQS
        * エンキューはAPIのリクエストで受付
* 考察
    * ジョブキューの部分を切り出す
				* 候補
            * Lumen
                * PHP製マイクロフレームワーク
                * Queues + SQSによる非同期処理が可能
                * 充実したテスト機構
            * Rails
                * Ruby製フレームワーク
                * APIモードにより、API開発がし易い
                * ActiveJob + SQSによる非同期処理が可能
		* Railsを採用
        * Laravel or Railsの甲乙はつけづらかった
    		* それでもRailsを選んだ理由
    				* APIモードによるAPI開発のしやすさ
    				* 充実したテスト機構
            * ActiveJobのバックエンドを環境別に簡単切り替え
            * ローカル環境でActiveJobの実行ができる
    				* 友人のRailsエンジニアが全体を設計。コードレビューを受けつつ開発。
* 興味
* PHPと比較して
    * 全てがオブジェクトなので自然に書ける。
    * メソッドチェインが良い。
    * unless, 後置if が好み
    * 1メソッドの単位が小さくなる
    * php.iniのようなファイルが無い
* CakePHPと比較して
    * CakePHPはRailsの影響を受けていた。
    * CakePHPは配列地獄になるので辛い
    * Railsは初期の学習コストが高い。
* CakePHPから乗り換えるべきか
    * 全体乗り換えは時間的コストに見合わない
    * 新規開発や今回のような一部機能の切り出しなら有り
* 良かったこと
    * 技術的負債の一部を返済できた
    * 充実したテスト環境を得た
    * ローカルでも開発しやすい環境を得た
* 悪かったこと
    * 実装に時間がかかった
        * 初期の学習コストが高い
    * まだ高速で開発できない（技量の問題
* まとめ
    * API開発の容易さ、エコシステムの魅力から今後も継続して利用していきたい
    * ActiveJobを利用すれば、簡単に非同期処理が実装できる

## メモ
### 1. プロポーザル概要
表題：PHPアプリケーションへの、マイクロサービスジョブキューシステムの導入

レガシー化したPHPアプリケーションで、独自のジョブキューシステムを開発・運用していました。システムこそ正常に動いていましたが、スパゲッティコード化、動作検証が困難という課題を抱えていました。

ジョブキューシステムの再構築にあたり、各種フレームワーク・ミドルウェアを検討した結果、Rails + SQSを利用して再構築しました。PHPerが、なぜRailsを選択したのか。選択した理由、良かったこと、悪かったことは何かをお話します。

### 2. 問題提起
* 古いCakePHPを利用しており、ジョブキューの仕組みがなく、独自で実装していた
* スパゲッティコード化した状態に、これ以上手を加えるのが億劫になっていた
* ユニットテストが未導入で、動作検証が困難だった。
### 3. 考察
* ユニットテストを入れようか検討した
    * 候補：PHPUnit, SimpleTest
    * PHPUnitは、CakePHPのバージョン都合で導入できなかった
    * PHPUnitがPHP界隈のデファクト・スタンダードだったので、SimpleTestを導入するのは消極的
    * とはいえ、それしか選択肢がなければ、するしかないのだが・・・
* ジョブキューの部分を切り出す案を検討した
    * Laravel
        * PHP製フレームワークの定番
        * Queues + SQSによる非同期処理が可能
        * 充実したテスト機構
    * Rails
        * Ruby製フレームワークの定番
        * APIモードにより、API開発がし易い
        * ActiveJob + SQSによる非同期処理が可能
        * 充実したテスト機構
### 4. 提案
* Laravel or Railsの甲乙が付けづらかったが、興味 + エコシステム + 言語としての魅力 + テストの書きやすさからRailsを選択
* Rails 5 API + SQSによるマイクロサービスジョブキューシステムを構築
### 5. 【重要】考察
* 良かったこと
    * 【感動した】MacにRubyがすんなり入って環境構築が楽（稀にNokogiriの何かでハマると死にたくなる
    	  * phpだとビルド時に関連ライブラリ不足で躓くことが多い
    * 【文化の違い】php.iniが無い！！！！
      	* PHPのアップグレード時の課題になる
    * 【機能面の優位】Rails 5のAPIモードを利用することで、特別な設定無く、REST APIが実装できる
    * 【機能面の優位】Active Jobによりバックエンドのデータ保存を抽象化できる
      	* 本番ではSQS、ローカル環境ではRedis
    * 【機能面の優位】Request, Contoller, Model, Jobと各レイヤーのテストが書ける
    * 【機能面の優位】ORMが直感的
* 悪かったこと
    * 【PHPer視点】gemの名前が、機能と直結しておらず分かりにくい
    * 【文化の違い】関連するgemが多すぎて、各gemの用途の理解が困難
    * コードの美学にこだわりすぎてる人が多い気がする（印象です。
    * 便利すぎてブラックボックス感がある
      	* 学習コストが高い 
