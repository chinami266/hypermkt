# PHPカンファレンス2017

## タイトル
できるPHP7アップグレード

## テーマ
Challenge!

## 概要
```
PHPを利用したウェブサイトの約66%(※1)は、セキュリティサポートの切れたPHP5.5以下のバージョンを利用しています。
アップグレードの必要性は理解していても、後方互換性のない変更点の修正が課題となり後回しにする現場も少なくないでしょう。

先日ホームページ作成サービス「グーペ」をPHP5.2から7.1へアップグレードし、そこから得られた知見をブログ(※2)にて公開しました。
本セッションではブログでお伝えきれなかった内容を加えて、安全かつ短期間でアップグレードする方法をご紹介します。

※1 https://w3techs.com/technologies/details/pl-php/all/all
※2 http://tech.pepabo.com/2017/06/21/goope-php71-upgrade/
```

## ストーリー
* 『起』プレゼンのテーマ・結論の提示
    * PHP7.1はパフォーマンス向上（CPU負荷減・レスポンスタイム減）、起動・動作が高速なDocker開発環境
* 『承』テーマの深化（課題における詳細など）
* 『転』課題の解決策の提案・聞き手側の不安の解消
* 『結』結論の再提示

## メモ
### ブログ
* 8年目のホームページ作成サービス「グーペ」
* なぜ8年目のタイミングでアップグレードをしたのか
* PHP5.2との後方互換性を維持する
* deprecatedの対応は優先度低め
* 新旧両バージョンで継続的テスト
* より広範囲をカバーできるE2Eテストを重視
* リアルタイムエラー検知
* 下位互換性のない変更点の修正
* php7ccによる互換性の自動検知
* MySQL関数の削除
* preg_replaceへの置き換え
* PHP7.1用php.iniの作成
* アプリケーションの応答速度の向上
* CPU負荷

### その他
* 複数ロールあった場合の優先順位
* プリペアドステートメント
* インフラエンジニアもPHPコーディング
* PHP-CS-Fixer導入
* Docker開発環境
* 常に最新を利用する
* RSSで最新情報を検知
* 飽き対策
* 難易度　飽きのグラフ
* ローカル環境
* 一気にやる
* 細かいphp7化の対策
* 社内ライブラリ化
* デプロイ
* デザイナー共有
* まず初めに不要ファイルの削除
    * 最初の頃は気づかなかったが、作業を進めていくうちに、修正ファイルが未使用であることに気づいた
    * こんだけ修正してコミットしたら未使用だと気づいた時の絶望感
    * 未使用コードを放置
        * 二次災害 => あとで使ってないことが判明して時間の無駄だと気づく
        * 使うかもしれない => 来ない
    * コードを置き去りにして機能を作ってきた
        * ロリポのコードが入ってた
        * 未使用のライブラリ
    * そこから学んだこと
        * まず未使用コードを探して削除しておくこと
        * 使ってそうなコードもディレクターと相談して機能廃止に。
    * メモ
        * 削除時のPR
        * Contributersのグラフ
* magic_quotes_gpc
* register_globals
* 共通ライブラリのgit subtree化
* 古いライブラリを削除してPHPネイティブ関数への置換え
* error_reporting
* リリース前のテストの仕方
* 既存ライブラリのComposer化
* func_get_args
* 大事なことなので2回言いたい
    * E2Eテスト
    * リアルタイムエラー通知
    * 新旧両バージョンでテスト
    * ブランチ運用
* バッチ処理の検証
* 決済、外部API連携
* magic_quotes_gpc
* $argv
* インフラ・開発と協力したプロジェクトの進め方
* PHP_VERSION_ID
    * autoload利用箇所の分岐
* PHPのアップグレード先の検討
    * 5.6も考えたが、7.1にした
    * その理由
* 温度感を伝えない
* PHP5.2 当時は最新だったが、それから8年・・・
* 丸8年
* バッチ処理を全て完走するまで見送るため一ヶ月様子見
* まず最初にすることは決裁者から許可をもらうこと
    * グーペ お申込み数2倍にした
    * 今後の成長のため開発スピードをあげたい
    * 誰がいつどこでなんで
* 説得した要因
    * サービスが成長していた
    * ビジネスと技術の両輪
* おっくん
    * その人を知りたい
    * 見に来ているのではなく、聞きに行く
    * 自分の視点の話
    * 目に見える判断基準 なんでそうしたんだろう、なんでそれに気づいたんだろう
    * その人らしさ

## 参考
* [PHPカンファレンス2017 \- \#phpcon2017](http://phpcon.php.gr.jp/2017/)
* [グーペのPHPバージョンを5\.2から7\.1にアップグレードしました \- ペパボテックブログ](https://tech.pepabo.com/2017/06/21/goope-php71-upgrade/)
* [カンファレンス発表の技術 // Speaker Deck](https://speakerdeck.com/hsbt/kanhuarensufa-biao-falseji-shu)
* [起承転結の意味を理解するために一番簡単な考え方](http://kyakuhon.terukosan.com/kishotenketu-imi/)
